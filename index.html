<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spencer Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        #welcome-page {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .text-container {
            font-weight: bold;
            font-size: 3rem;
            line-height: 1.5;
            margin-bottom: 2rem;
        }

        .fade-text {
            text-shadow: 3px 3px 7px rgba(0, 0, 0, 0.6);
            background: linear-gradient(to right, #FFA500, #FF4500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .fade-text::after {
            content: "|";
            animation: blink 1s infinite;
            color: #FFA500;
        }

        .tap-to-chat {
            display: block;
            margin-top: 15px;
            font-size: 1.8rem;
            font-weight: normal;
            color: #FFA500;
        }

        #app-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-box {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #000;
            padding-bottom: 60px;
            scroll-behavior: smooth;
            scroll-padding-bottom: 100px;
        }

        .message {
            margin: 15px;
            padding: 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user {
            background-color: #1a1a1a;
            margin-left: auto;
            margin-right: 10px;
        }

        .bot {
            background-color: #252525;
            margin-right: auto;
            margin-left: 10px;
            position: relative;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
            padding-right: 40px;
        }

        .typing {
            display: flex;
            padding: 10px;
            margin: 10px;
            border-radius: 20px;
            background-color: #252525;
            max-width: 80%;
            margin-right: auto;
            margin-left: 10px;
        }

        .typing-dots {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background: white;
            border-radius: 50%;
            animation: blink 1.4s infinite;
        }

        .typing-dots:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots:nth-child(3) {
            animation-delay: 0.4s;
        }

        #input-container {
            display: flex;
            padding: 10px;
            background: #28282B;
        }

        #user-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            background: #1e1e1e;
            color: white;
            outline: none;
        }

        #send-button {
            padding: 15px;
            background: linear-gradient(45deg, #4CAF50, #45A049);
            color: white;
            border: none;
            border-radius: 25px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .bottom-nav {
            display: flex;
            background: #1e1e1e;
            border-top: 1px solid #333;
        }

        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-item.active {
            background: #333;
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        #nameModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            display: none;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        #nameInput, #emailInput {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #555;
            border-radius: 90px;
            margin-bottom: 15px;
            background-color: #2c2c2c;
            color: white;
            outline: none;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        #saveButton {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #00b894;
            color: white;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .copy-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            width: 25px;
            height: 25px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.bot:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn i {
            font-size: 12px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .simple-modal {
            background: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .modal-btn.confirm {
            background: #d63031;
            color: white;
        }

        .modal-btn.cancel {
            background: #333;
            color: white;
        }

        .thinking-mode {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #252525;
            border-radius: 15px;
            margin: 10px 15px;
            max-width: 80%;
            align-self: flex-start;
            animation: fadeIn 0.3s ease-out;
        }

        .thinking-text {
            font-size: 14px;
            color: #aaa;
            margin-right: 8px;
        }

        .thinking-dots {
            display: flex;
            gap: 5px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FFA500;
            opacity: 0.4;
            animation: thinking-pulse 1.5s infinite ease-in-out;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking-pulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(0.9);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .chat-welcome-message {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #FFA500;
    font-family: 'Montserrat', 'Poppins', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    opacity: 0.9;
    pointer-events: none;
    transition: all 0.3s ease-in-out;
    z-index: 1;
    width: 90%;
    max-width: 600px;
    padding: 20px;
    line-height: 1.3;
}

        .chat-welcome-message.faded {
            opacity: 0;
            visibility: hidden;
        }

        #network-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #network-status.online {
            background-color: #00c853;
            color: white;
            animation: pulseOnline 2s infinite;
        }

        #network-status.offline {
            background-color: #d50000;
            color: white;
            animation: pulseOffline 2s infinite;
        }

        @keyframes pulseOnline {
            0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 200, 83, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); }
        }

        @keyframes pulseOffline {
            0% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(213, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0); }
        }

        #new-chat-btn-container {
            position: fixed;
            bottom: 200px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 999;
            padding: 0 20px;
        }

        #new-chat-btn {
            background: #1a1a1a;
            color: white;
            border: 1px solid #333;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #new-chat-btn:hover {
            background: #252525;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .message.bot .chat-link {
            color: #FFA500;
            text-decoration: underline;
            word-break: break-all;
            transition: all 0.2s ease;
        }

        .message.bot .chat-link:hover {
            color: #FF8C00;
            text-decoration: none;
        }

        #settings-page {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: #121212;
        }

        .settings-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .settings-container h2 {
            color: #FFA500;
            margin-bottom: 20px;
            text-align: center;
        }

        .storage-meter-container {
            margin-bottom: 30px;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .storage-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .storage-meter {
            height: 10px;
            background: #252525;
            border-radius: 5px;
            overflow: hidden;
        }

        .storage-progress {
            height: 100%;
            background: linear-gradient(90deg, #FFA500, #FF4500);
            width: 0%;
            transition: width 0.3s ease;
        }

        .action-btn {
            background: linear-gradient(45deg, #d63031, #ff7675);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(214, 48, 49, 0.3);
        }

        @media (max-width: 768px) {
            .text-container {
                font-size: 2rem;
            }

            .copy-btn {
                opacity: 1 !important;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
                padding: 12px;
            }
        }

        /* Storage Description Text */
.storage-description {
    text-align: center;
    margin: 20px 0;
    font-size: 1.1rem;
    color: #FFA500;
    font-weight: bold;
    text-shadow: 0 0 8px rgba(255,165,0,0.3);
    padding: 0 15px;
    line-height: 1.5;
}

/* User Guide Section */
.user-guide-section {
    margin-top: 30px;
    border-top: 1px solid #333;
    padding-top: 20px;
}

.guide-header {
    color: #FFA500;
    text-align: center;
    margin-bottom: 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.guide-chevron {
    margin-left: 8px;
    transition: transform 0.3s;
}



//For Modal
#userGuideModal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#userGuideModal.active {
  opacity: 1;
  pointer-events: all;
}

//For The Ai model card
.settings-card {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #333;
    color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.settings-card h3 {
    margin-bottom: 10px;
    font-size: 1.2rem;
    color: #FFA500;
}

.settings-card p {
    margin-bottom: 10px;
    font-size: 0.95rem;
    color: #ccc;
}

#modelSelect {
    background-color: #2c2c2c;
    color: white;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 10px;
    font-size: 1rem;
    width: 100%;
    transition: border 0.3s, background-color 0.3s;
}

#modelSelect:focus {
    outline: none;
    border-color: #FFA500;
    background-color: #1f1f1f;
}

pre {
    background: #111;
    color: #00FFAA;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    overflow-x: auto;
    font-size: 0.9rem;
    line-height: 1.5;
}

code {
    background: #222;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #FFA500;
}

.code-block {
    position: relative;
    margin-top: 1em;
}

.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #FFA500;
    color: black;
    border: none;
    padding: 5px 10px;
    font-size: 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s ease;
    z-index: 2;
}

.copy-btn:hover {
    background: #ff8000;
}

pre {
    background: #111;
    color: #00FFAA;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    overflow-x: auto;
    font-size: 0.9rem;
    line-height: 1.5;
}

code {
    background: #222;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #FFA500;
}

.bot-message, .bot-message * {
  -webkit-user-select: text !important;
  user-select: text !important;
  cursor: text;
}

/*privacy policy modal*/
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-content {
    background: #1e1e1e;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    color: white;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    max-height: 80vh;
    overflow-y: auto;
}

.modal-content h2 {
    margin-top: 0;
    color: #FFA500;
}

.modal-content ol {
    padding-left: 20px;
    line-height: 1.6;
}

.modal-content a {
    color: #FFA500;
    text-decoration: underline;
}

.close-button {
    background: #FFA500;
    color: black;
    border: none;
    padding: 10px 20px;
    margin-top: 20px;
    border-radius: 6px;
    cursor: pointer;
}
   </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div id="welcome-page">
        <div class="text-container">
            <div id="animatedText" class="fade-text"></div>
        </div>
    </div>

    <button id="reset-user" style="position: fixed; bottom: 70px; right: 10px; z-index: 1000; padding: 8px 12px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Reset User
    </button>

    <div id="app-container">
        <div id="settings-page">
            <div class="settings-container">
                <h2>Storage Settings</h2>
                <div class="storage-meter-container">
                    <div class="storage-info">
                        <span id="storage-used">0 KB</span> used of <span id="storage-total">5 MB</span>
                    </div>
                    <div class="storage-meter">
                        <div id="storage-progress" class="storage-progress"></div>

                    </div>
                </div>

                <!-- ADD THIS NEW STORAGE DESCRIPTION TEXT -->
        <p class="storage-description">
            🔋 Your AI companion has stored <span id="storage-percentage">0%</span> of knowledge locally
            for instant offline access!
        </p>

                <button id="clear-storage-btn" class="action-btn">
                    <i class="fas fa-trash-alt"></i> Clear All Chat Data
                </button>

                <div class="settings-card">
    <h3><i class="fas fa-robot"></i> AI Model</h3>
    <p>Choose which model Spencer should use:</p>
    <select id="modelSelect" style="margin-top:10px; width:100%; padding:10px; border-radius:8px;">
    </select>
</div>

                <!-- User Guide Section -->
        <div class="user-guide-section">
            <h3 class="guide-header" id="openUserGuide">
                <i class="fas fa-question-circle"></i> User Guide
                <i class="fas fa-chevron-down guide-chevron"></i>
            </h3>


        </div>

        <div class="settings-card">
    <h3><i class="fas fa-user-shield"></i> Privacy Policy</h3>
    <p>We respect your privacy and want you to know how Spencer works.</p>
    <button onclick="openModal('privacyModal')" class="settings-button">View Privacy Policy</button>
</div>
    </div>
</div>


        <div id="chat-container">
            <div id="chat-box"></div>

            <div id="new-chat-btn-container">
                <button id="new-chat-btn">
                    <i class="fas fa-comment"></i> New Chat
                </button>
            </div>

            <div id="input-container">
                <textarea id="user-input" placeholder="Message..." rows="2"></textarea>
                <button id="send-button">Send</button>
            </div>
            <div id="network-status" class="offline">Offline</div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="nav-chat">
                <i class="fas fa-comment-alt"></i>
                <div>Chat</div>
            </div>
            <div class="nav-item" id="nav-settings">
                <i class="fas fa-cog"></i>
                <div>Settings</div>
            </div>
        </div>
    </div>

    <div id="nameModal">
        <div class="modal-content">
            <h2>Hi, I'm Spencer.<br>What's your name & email?</h2>
            <input type="text" id="nameInput" placeholder="Enter your name here">
            <input type="email" id="emailInput" placeholder="Enter your email here">
            <div class="button-group">
                <button id="saveButton">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="simple-modal">
            <h3>Clear All History?</h3>
            <p>This will permanently delete all your chat history.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelClear">Cancel</button>
                <button class="modal-btn confirm" id="confirmClear">Clear</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            chatHistoryKey: "spencer_chat_history",
            userNameKey: "spencer_user_name",
            userEmailKey: "spencer_user_email",
            geminiApiKey: "AIzaSyCYbhOMG6KKiNW6xNyyO2tCt2hWF3fBCDo"
        };

        const MODELS = {
    gemini15: {
        name: "Gemini 1.5 Flash",
        endpoint: "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        apiKey: CONFIG.geminiApiKey,
        type: "gemini"
    },
    gemini20: {
        name: "Gemini 2.0 Flash",
        endpoint: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
        apiKey: CONFIG.geminiApiKey,
        type: "gemini"
    },
    deepseek: {
        name: "Deepseek Prover V2",
        endpoint: "https://openrouter.ai/api/v1/chat/completions",
        apiKey: "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",
        type: "openrouter",
        model: "deepseek/deepseek-prover-v2:free"
    },
    meta_llama: {
        name: "Meta LLaMA 3.3 8B Instruct",
        endpoint: "https://openrouter.ai/api/v1/chat/completions",
        apiKey: "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",
        type: "openrouter",
        model: "meta-llama/llama-3.3-8b-instruct:free"
    },
    qwen: {
        name: "Qwen 3 4B",
        endpoint: "https://openrouter.ai/api/v1/chat/completions",
        apiKey: "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",
        type: "openrouter",
        model: "qwen/qwen3-4b:free"
    },

    gemma: {
    name: "Google Gemma 3 4B IT",
    endpoint: "https://openrouter.ai/api/v1/chat/completions",
    apiKey: "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",
    type: "openrouter",
    model: "google/gemma-3-4b-it:free"
}

};
        // DOM Elements
        const THINKING_MESSAGES = [
            "Processing your request...",
            "Thinking carefully...",
            "Generating response...",
            "Working on it...",
            "Give me a sec...",
            "hmmm..."
        ];

        const welcomePage = document.getElementById('welcome-page');
        const appContainer = document.getElementById('app-container');
        const chatContainer = document.getElementById('chat-container');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const navChat = document.getElementById('nav-chat');
        const navSettings = document.getElementById('nav-settings');
        const nameModal = document.getElementById('nameModal');
        const nameInput = document.getElementById('nameInput');
        const emailInput = document.getElementById('emailInput');
        const saveButton = document.getElementById('saveButton');
        const animatedText = document.getElementById('animatedText');
        const settingsPage = document.getElementById('settings-page');
        const clearStorageBtn = document.getElementById('clear-storage-btn');
        const storageUsedEl = document.getElementById('storage-used');
        const storageTotalEl = document.getElementById('storage-total');
        const storageProgressEl = document.getElementById('storage-progress');
        const newChatBtn = document.getElementById('new-chat-btn');
        const resetUserBtn = document.getElementById('reset-user');

        // State
        let currentPage = 'chat';
        let isOnline = navigator.onLine;

        // Initialize the app
        function initApp() {
            const savedUsername = localStorage.getItem(CONFIG.userNameKey);
            if (!savedUsername) {
                showNameModal();
            } else {
                displayWelcomeMessage(savedUsername);
            }
            setupEventListeners();
            initNetworkStatus();

            updateStorageMeter(); // <- add this to ensure the percentage gets computed

            function populateModelSelector() {
    const selector = document.getElementById("modelSelect");
    selector.innerHTML = '';

    for (const key in MODELS) {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = MODELS[key].name;
        selector.appendChild(option);
    }

    const saved = localStorage.getItem("selectedModel") || "gemini15";
    selector.value = saved;

    selector.addEventListener("change", () => {
        localStorage.setItem("selectedModel", selector.value);
    });
}

populateModelSelector();

        }

        function setupEventListeners() {
            welcomePage.addEventListener('click', startChatApp);

            userInput.addEventListener("keydown", function(event) {
                if (event.key === "Enter" && !event.ctrlKey) {
                    return;
                }
                if (event.key === "Enter" && event.ctrlKey) {
                    event.preventDefault();
                    sendButton.click();
                }
            });

            clearStorageBtn.addEventListener('click', showClearStorageConfirmation);
            sendButton.addEventListener('click', sendMessage);
            navChat.addEventListener('click', () => switchPage('chat'));
            navSettings.addEventListener('click', () => switchPage('settings'));
            saveButton.addEventListener('click', saveNameAndEmail);
            resetUserBtn.addEventListener('click', resetUser);
            newChatBtn.addEventListener('click', startNewChat);

            document.getElementById('confirmModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('confirmModal')) {
                    document.getElementById('confirmModal').classList.remove('active');
                }
            });

            document.getElementById('confirmClear').addEventListener('click', () => {
                localStorage.removeItem(CONFIG.chatHistoryKey);
                loadChatHistory();
                document.getElementById('confirmModal').classList.remove('active');
                updateStorageMeter();
            });

            document.getElementById('cancelClear').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('active');
            });
        }

        function initNetworkStatus() {
            updateNetworkIndicator();
            window.addEventListener('online', handleNetworkChange);
            window.addEventListener('offline', handleNetworkChange);
        }

        function handleNetworkChange() {
            isOnline = navigator.onLine;
            updateNetworkIndicator();

            if (isOnline) {
                showTemporaryStatus("You're back online!", 'online');
            } else {
                showTemporaryStatus("You've gone offline", 'offline');
            }
        }

        function updateNetworkIndicator() {
            const networkStatus = document.getElementById("network-status");
            if (!networkStatus) return;

            if (isOnline) {
                networkStatus.className = "online";
                networkStatus.innerHTML = '<i class="fas fa-wifi"></i> Online';
            } else {
                networkStatus.className = "offline";
                networkStatus.innerHTML = '<i class="fas fa-plug"></i> Offline';
            }
        }

        function showTemporaryStatus(message, type) {
            const status = document.createElement('div');
            status.className = `network-alert ${type}`;
            status.innerHTML = message;
            document.body.appendChild(status);

            setTimeout(() => {
                status.classList.add('fade-out');
                setTimeout(() => status.remove(), 1000);
            }, 3000);
        }

        function showNameModal() {
            nameModal.style.display = 'block';
        }

        function hideNameModal() {
            nameModal.style.display = 'none';
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        async function saveNameAndEmail() {
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();

            if (!name) {
                alert('Please enter a valid name!');
                return;
            }
            if (!email) {
                alert('Please enter your email!');
                return;
            }
            if (!isValidEmail(email)) {
                alert('Please enter a valid email address!');
                return;
            }

            saveButton.disabled = true;
            saveButton.textContent = 'Sending...';

            try {
                const submissionSuccess = await submitUserInfo(name, email);

                if (submissionSuccess) {
                    localStorage.setItem(CONFIG.userNameKey, name);
                    localStorage.setItem(CONFIG.userEmailKey, email);
                    hideNameModal();
                    displayWelcomeMessage(name);
                } else {
                    alert('Failed to submit your information. Please try again.');
                }
            } catch (error) {
                console.error('Error in saveNameAndEmail:', error);
                alert('An unexpected error occurred. Please try again.');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save';
            }
        }

      async function submitUserInfo(name, email) {
    const formSubmitURL = 'https://formsubmit.co/ajax/ukowills@gmail.com'; // AJAX endpoint

    const data = {
        name: name,
        email: email,
        _subject: "New User Sign-up from Spencer Chat",
        _template: "table",
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch(formSubmitURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data),
        });

        // Parse JSON response (FormSubmit returns { success: true/false })
        const result = await response.json();

        // Check if FormSubmit confirmed success
        if (result.success) {
            console.log("Form submitted successfully:", result);
            return true;
        } else {
            console.error("FormSubmit returned an error:", result.message);
            return false;
        }

    } catch (error) {
        console.error('Network/API error:', error);
        return false;
    }
}

        function displayWelcomeMessage(name = null) {
            const timeGreeting = getTimeGreeting();
            let greetingText;

            if (name) {
                greetingText = `${timeGreeting}, ${name}. Tap to chat`;
            } else {
                greetingText = `${timeGreeting}. I'm Spencer. Tap to chat`;
            }
            animateText(greetingText);
        }

        function animateText(text) {
            animatedText.textContent = "";
            let index = 0;
            function typeWriter() {
                if (index < text.length) {
                    animatedText.textContent += text.charAt(index);
                    index++;
                    setTimeout(typeWriter, 50);
                }
            }
            typeWriter();
        }

        function getTimeGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good morning";
            if (hour < 18) return "Good afternoon";
            return "Good evening";
        }

        function startChatApp() {
            welcomePage.style.display = 'none';
            appContainer.style.display = 'flex';
            loadChatHistory();
        }

        function switchPage(page) {
    currentPage = page;
    if (page === 'chat') {
        chatContainer.style.display = 'flex';
        settingsPage.style.display = 'none';
        navChat.classList.add('active');
        navSettings.classList.remove('active');
    } else if (page === 'settings') {
        chatContainer.style.display = 'none';
        settingsPage.style.display = 'block';
        navChat.classList.remove('active');
        navSettings.classList.add('active');

        console.log('[debug] Loading settings page...');
        updateStorageMeter(); // <-- add this here to be safe
    }
}
        // Add this to your settings page initialization
function loadSettingsPage() {
    updateStorageMeter();

    // Update the percentage display
    const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];
    const historySize = JSON.stringify(history).length;
    const percentage = Math.min(100, Math.round((historySize / (5 * 1024 * 1024)) * 100));
    document.getElementById('storage-percentage').textContent = `${percentage}%`;
}


function toggleFAQ(element) {
    const answer = element.querySelector('.faq-answer');
    answer.style.display = answer.style.display === 'none' ? 'block' : 'none';
}
        function updateStorageMeter() {
    try {
        const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];
        const historySize = JSON.stringify(history).length;
        const usedKB = (historySize / 1024).toFixed(2);
        const percentage = Math.min(100, (historySize / (5 * 1024 * 1024)) * 100);

        // Update all storage displays
        storageUsedEl.textContent = `${usedKB} KB`;
        storageTotalEl.textContent = `5 MB`;
        document.getElementById('storage-percentage').textContent = `${Math.round(percentage)}%`; // <<< ADD THIS
        storageProgressEl.style.width = `${percentage}%`;

        // Color coding
        if (percentage > 90) {
            storageProgressEl.style.background = 'linear-gradient(90deg, #d63031, #ff7675)';
            document.querySelector('.storage-description').style.color = '#ff6b6b';
        } else if (percentage > 70) {
            storageProgressEl.style.background = 'linear-gradient(90deg, #f39c12, #f1c40f)';
            document.querySelector('.storage-description').style.color = '#feca57';
        } else {
            storageProgressEl.style.background = 'linear-gradient(90deg, #FFA500, #FF4500)';
            document.querySelector('.storage-description').style.color = '#FFA500';
        }
    } catch (e) {
        console.error("Error calculating storage:", e);
    }
}

        function showClearStorageConfirmation() {
            document.getElementById('confirmModal').classList.add('active');
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            const welcomeMsg = document.querySelector('.chat-welcome-message');
            if (welcomeMsg) {
                welcomeMsg.classList.add('faded');
            }

            addMessage(message, 'user');
            userInput.value = '';

            const cachedResponse = checkCache(message);
            if (cachedResponse) {
                addMessage(cachedResponse, 'bot');
                return;
            }

            if (isOnline) {
                const thinkingElement = createThinkingElement();
                chatBox.appendChild(thinkingElement);

                try {
                    const response = await generateResponse(message);
                    chatBox.removeChild(thinkingElement);
                    addMessage(response, 'bot');
                    saveToCache(message, response);
                } catch (error) {
                    console.error("API Error:", error);
                    chatBox.removeChild(thinkingElement);
                    const fallback = getOfflineResponse(message);
                    addMessage(fallback, 'bot');
                }
            } else {
                const fallback = getOfflineResponse(message);
                addMessage(fallback, 'bot');
            }
        }

        function createThinkingElement() {
            const container = document.createElement('div');
            container.className = 'thinking-mode';

            const text = document.createElement('span');
            text.className = 'thinking-text';
            text.textContent = THINKING_MESSAGES[Math.floor(Math.random() * THINKING_MESSAGES.length)];

            const dots = document.createElement('div');
            dots.className = 'thinking-dots';

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'thinking-dot';
                dots.appendChild(dot);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            container.appendChild(text);
            container.appendChild(dots);

            return container;
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    ${text}
                    <button class="copy-btn" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                    </button>
                `;

                const copyBtn = messageDiv.querySelector('.copy-btn');
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(text).then(() => {
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        copyBtn.style.background = '#4CAF50';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            copyBtn.style.background = '#333';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                        copyBtn.style.background = '#f44336';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            copyBtn.style.background = '#333';
                        }, 2000);
                    });
                });
            } else {
                messageDiv.textContent = text;
            }

            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function generateResponse(input) {
    console.log("User Input:", input);

    try {
        const selectedKey = localStorage.getItem("selectedModel") || "gemini15";
        const model = MODELS[selectedKey];

        let body, headers, url = model.endpoint;

        if (model.type === "gemini") {
            headers = { "Content-Type": "application/json" };
            body = {
                contents: [{
                    parts: [{ text: input }]
                }]
            };
            url += `?key=${model.apiKey}`;
        } else if (model.type === "openrouter") {
            headers = {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${model.apiKey}`
            };
            body = {
                model: model.model,
                messages: [
                    { role: "user", content: input }
                ]
            };
        } else {
            throw new Error("Unsupported model type");
        }

        const response = await fetch(url, {
            method: "POST",
            headers,
            body: JSON.stringify(body)
        });

        const data = await response.json();
        console.log("API Response:", data);

        if (model.type === "gemini") {
            if (data.candidates && data.candidates[0].content.parts[0].text) {
                return formatBotResponse(data.candidates[0].content.parts[0].text);
            }
        } else if (model.type === "openrouter") {
            if (data.choices && data.choices[0].message.content) {
                return formatBotResponse(data.choices[0].message.content);
            }
        }

        console.error("Unexpected API response format");
        return getOfflineResponse(input);

    } catch (error) {
        console.error("API error:", error);
        return getOfflineResponse(input);
    }
}
        function formatBotResponse(text) {
    // Convert links
    text = text.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="chat-link">$1</a>'
    );

    // Convert markdown headers to H1/H2/H3
    text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');

    // Convert multiline code blocks (```lang\ncode```)
    text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, function(_, lang, code) {
        const safeCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `
            <div class="code-block">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code class="language-${lang || 'text'}">${safeCode}</code></pre>
            </div>
        `;
    });

    // Convert inline code `like this`
    text = text.replace(/`([^`\n]+)`/g, '<code>$1</code>');

    // Convert markdown bold/italic
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

    // Convert double newlines to paragraphs, single to <br>
    text = text.replace(/\n{2,}/g, '</p><p>');
    text = text.replace(/\n/g, '<br>');

    // Wrap content in paragraph tags if not already block-level
    if (!text.startsWith('<p>')) text = '<p>' + text;
    if (!text.endsWith('</p>')) text += '</p>';

    return text.replace(/<p><\/p>/g, '').trim();
}

function copyCode(button) {
    const code = button.parentElement.querySelector("pre code");

    if (!code) {
        console.error("Code block not found");
        return;
    }

    const rawCode = code.textContent;

    navigator.clipboard.writeText(rawCode).then(() => {
        button.textContent = "Copied!";
        setTimeout(() => {
            button.textContent = "Copy";
        }, 1500);
    }).catch(err => {
        console.error("Copy failed", err);
        button.textContent = "Failed";
    });
}
        function getOfflineResponse(input) {
            try {
                const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];

                const exactMatch = history.findLast(entry =>
                    entry.user.toLowerCase() === input.toLowerCase()
                );
                if (exactMatch) return exactMatch.bot;

                const keywords = input.toLowerCase().split(/\s+/);
                const keywordMatch = history.findLast(entry =>
                    keywords.some(keyword =>
                        entry.user.toLowerCase().includes(keyword) &&
                        keyword.length > 3
                    )
                );

                if (keywordMatch) {
                    return formatRelevantResponse(keywordMatch.bot);
                }

                const similarMatch = findSemanticallySimilar(input, history);
                if (similarMatch) return similarMatch.bot;

            } catch (e) {
                console.error("Cache access error:", e);
            }

            return getRandomFallbackResponse();
        }

        function formatRelevantResponse(botResponse) {
            const phrases = [
                "This might help:",
                "Relevant information I found:",
                "Here's what I know:",
                "This could be useful:",
                "From my knowledge:"
            ];
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            return `${randomPhrase}<br><br>${botResponse}`;
        }

        function findSemanticallySimilar(input, history) {
            const inputWords = new Set(input.toLowerCase().split(/\W+/));
            return history.findLast(entry => {
                const entryWords = new Set(entry.user.toLowerCase().split(/\W+/));
                const intersection = [...inputWords].filter(word =>
                    word.length > 3 && entryWords.has(word)
                );
                return intersection.length >= 2;
            });
        }

        function getRandomFallbackResponse() {
    const online = navigator.onLine;

    if (online) {
        const messages = [
            "Hmm... this model might be on cooldown or temporarily unavailable.",
            "Looks like something's blocking a response right now. Try switching to another model.",
            "This one’s taking a break! You can switch to another model for now.",
            "If you're online and seeing this, the current model may be rate-limited or broken.",
            "Spencer here. This model didn’t respond. Flip the switch and let’s keep going."
        ];

        const tip = messages[Math.floor(Math.random() * messages.length)];
        return `
            ${tip}<br><br>
            <button onclick="switchPage('settings')" style="
                background: linear-gradient(45deg, #FFA500, #FF4500);
                border: none;
                border-radius: 8px;
                padding: 10px 18px;
                font-weight: bold;
                cursor: pointer;
                color: white;
                margin-top: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            ">
                Switch Model
            </button>
        `;
    } else {
        const fallbacks = [
    "We’re flying offline and… oops, I don’t have this one saved. Reconnect for my full brain.",
    "Offline and out of ammo for this question. I’ll have more to say once we’re back online.",
    "I checked my offline memory… nothing on this one. Let’s try again with a signal.",
    "I’d love to help, but this question isn’t in my offline stash. Wi-Fi might save us.",
    "That one’s not in my local memory banks. Reconnect to unlock smarter answers!"
];
        return fallbacks[Math.floor(Math.random() * fallbacks.length)];
    }
}

        function saveToCache(userMsg, botMsg) {
            try {
                let history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];

                history.push({
                    user: userMsg,
                    bot: botMsg,
                    timestamp: new Date().toISOString()
                });

                if (history.length > 100) {
                    history = history.slice(-100);
                }

                localStorage.setItem(CONFIG.chatHistoryKey, JSON.stringify(history));
                return true;
            } catch (e) {
                console.error("Error saving to cache:", e);
                return false;
            }
        }

        function checkCache(userMsg) {
            try {
                const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];
                const match = history.reverse().find(entry =>
                    entry.user.toLowerCase() === userMsg.toLowerCase()
                );
                return match ? match.bot : null;
            } catch (e) {
                console.error("Error checking cache:", e);
                return null;
            }
        }

        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];
            chatBox.innerHTML = '';

            history.forEach(entry => {
                addMessage(entry.user, 'user');
                addMessage(entry.bot, 'bot');
            });

            if (history.length === 0) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'chat-welcome-message';
                welcomeMsg.textContent = '';
                chatBox.appendChild(welcomeMsg);
            }
        }

        function startNewChat() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';

            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'chat-welcome-message';
            welcomeMsg.textContent = 'Hi, How Can I Help';
            chatBox.appendChild(welcomeMsg);

            chatBox.scrollTop = 0;
        }


        function resetUser() {
            localStorage.removeItem(CONFIG.userNameKey);
            localStorage.removeItem(CONFIG.userEmailKey);
            appContainer.style.display = 'none';
            welcomePage.style.display = 'flex';
            displayWelcomeMessage();
            alert("User data cleared. Welcome page will show again.");
        }

        document.addEventListener('DOMContentLoaded', () => {
    initApp();

    const openUserGuideBtn = document.getElementById('openUserGuide');
    const userGuideModal = document.getElementById('userGuideModal');
    const closeUserGuideBtn = document.getElementById('closeUserGuide');

    if (openUserGuideBtn && userGuideModal && closeUserGuideBtn) {
      openUserGuideBtn.addEventListener('click', () => {
        userGuideModal.classList.add('active');
      });

      closeUserGuideBtn.addEventListener('click', () => {
        userGuideModal.classList.remove('active');
      });

      userGuideModal.addEventListener('click', (e) => {
        if (e.target === userGuideModal) {
          userGuideModal.classList.remove('active');
        }
      });
    }
});


function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.add("active");
}

function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.remove("active");
}
    </script>
    <div id="userGuideModal" class="modal-overlay">
  <div class="simple-modal">
    <h3 style="color: #FFA726;">Quick User Guide</h3>
    <div class="modal-content-text" style="margin-top: 10px;">
      <p>Spencer AI works in both online and offline modes automatically.</p>

      <h4>🌐 Online Mode</h4>
      <ul>
        <li>Real-time AI responses</li>
        <li>Saves knowledge for offline use</li>
      </ul>

      <h4>🚫 Offline Mode</h4>
      <ul>
        <li>Uses saved knowledge</li>
        <li>Instant responses</li>
      </ul>

      <h4 style="margin-top: 15px;">FAQs</h4>
      <p><strong>How do I know my connection mode?</strong><br>
      The network indicator at the top shows Online or Offline status.</p>

      <p><strong>How does offline learning work?</strong><br>
      Spencer AI learns from your online chats and stores knowledge for offline use.</p>
    </div>
    <button id="closeUserGuide" class="modal-btn cancel" style="margin-top: 20px;">Close</button>
  </div>
</div>


<div id="privacyModal" class="modal-overlay">
    <div class="modal-content">
       <h2>Privacy Policy</h2>
<p><strong>Effective Date:</strong> Dec. 30, 2024</p>
<p><strong>Spencer AI Offline Chatbot</strong></p>
<p>YouNetwork ("we," "our," or "us") is committed to protecting your privacy.
<p> This Privacy Policy explains how we handle information related to the use of our app. By using Spencer AI Offline Chatbot, you agree to the terms outlined below.</p>

<ol>
  <li>
    <strong>Information We Collect</strong><br>
    Spencer may collect limited personal information such as your <strong>name</strong> and <strong>email address</strong>, which are stored securely on your device and our servers to enhance your user experience (e.g., personalizing conversations).
  </li>

  <li>
    <strong>Third-Party Advertisements</strong><br>
    Spencer AI Offline Chatbot may display advertisements provided by third-party ad networks ("Sponsors"). These third parties may collect limited technical data (e.g., device identifiers, general usage) to serve personalized or contextual ads. We do not control or store this data. Their practices are governed by their own privacy policies.
  </li>

  <li>
    <strong>Data Usage</strong><br>
    Your name and email are used locally to personalize your experience and may be displayed in user-facing features and used to send you emails relating this app changes.They are <strong>not shared externally</strong>.
  </li>

  <li>
    <strong>Data Retention & Deletion</strong><br>
    You can request to delete your data.
  </li>

  <li>
    <strong>Age Restrictions</strong><br>
    Spencer AI Offline Chatbot is intended for users aged <strong>13 and older</strong>. We do not knowingly collect information from users under 13 in violation of applicable laws (e.g., COPPA).
  </li>

  <li>
    <strong>Security</strong><br>
    We do not collect sensitive personal data. Third-party advertisers integrated with Spencer are expected to use secure, compliant systems to manage any technical data they handle.
  </li>

  <li>
    <strong>Policy Updates</strong><br>
    This Privacy Policy may be updated periodically to reflect changes in functionality, compliance, or third-party services. The effective date will always be updated, and you may view this policy within the app at any time.
  </li>

  <li>
    <strong>Contact Us</strong><br>
    For questions about this Privacy Policy, please email us at: <a href="mailto:YouNetworkdev@hotmail.com">YouNetworkdev@hotmail.com</a>
  </li>
</ol>

        <button onclick="closeModal('privacyModal')" class="close-button">Close</button>
    </div>
</div>
</body>
</html>
