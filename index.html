<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spencer Chat</title>
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* Welcome Page Styles */
        #welcome-page {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .text-container {
            font-weight: bold;
            font-size: 3rem;
            line-height: 1.5;
            margin-bottom: 2rem;
        }

        .fade-text {
            text-shadow: 3px 3px 7px rgba(0, 0, 0, 0.6);
            background: linear-gradient(to right, #FFA500, #FF4500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .fade-text::after {
            content: "|";
            animation: blink 1s infinite;
            color: #FFA500;
        }

        .tap-to-chat {
            display: block;
            margin-top: 15px;
            font-size: 1.8rem;
            font-weight: normal;
            color: #FFA500;
        }

        /* Main App Container (hidden initially) */
        #app-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        /* Chat Container */
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

       #chat-box {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    background-color: #000;
    /* Add these new properties */
    padding-bottom: 60px; /* Extra space at bottom */
    scroll-behavior: smooth; /* Smooth scrolling */
    scroll-padding-bottom: 100px; /* Keep space above input */
}

        .message {
            margin: 15px;
            padding: 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user {
            background-color: #1a1a1a;
            margin-left: auto;
            margin-right: 10px;
        }

        .bot {
            background-color: #252525;
            margin-right: auto;
            margin-left: 10px;
            position: relative;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        .typing {
            display: flex;
            padding: 10px;
            margin: 10px;
            border-radius: 20px;
            background-color: #252525;
            max-width: 80%;
            margin-right: auto;
            margin-left: 10px;
        }

        .typing-dots {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background: white;
            border-radius: 50%;
            animation: blink 1.4s infinite;
        }

        .typing-dots:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Input Area */
        #input-container {
            display: flex;
            padding: 10px;
            background: #28282B;
        }

        #user-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            background: #1e1e1e;
            color: white;
            outline: none;
        }

        #send-button {
            padding: 15px;
            background: linear-gradient(45deg, #4CAF50, #45A049);
            color: white;
            border: none;
            border-radius: 25px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        /* History Page */
        #history-page {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: #121212;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .history-card {
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: 1px solid #333;
        }

        .card-header {
            padding: 1.2rem;
            background: #252525;
            border-bottom: 1px solid #333;
        }

        .card-header h3 {
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
            color: #ffffff;
        }

        .card-header .date {
            font-size: 0.85rem;
            color: #aaa;
        }

        /* Update your existing .card-content styles */
.card-content {
    padding: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #FFA500 #252525;
}

/* Custom scrollbar for WebKit browsers */
.card-content::-webkit-scrollbar {
    width: 6px;
}

.card-content::-webkit-scrollbar-track {
    background: #252525;
}

.card-content::-webkit-scrollbar-thumb {
    background-color: #FFA500;
    border-radius: 3px;
}

/* Ensure continue button stays visible */
.continue-chat-btn {
    position: sticky;
    bottom: 0;
    background: #252525;
    z-index: 1;
    margin-top: 10px;
}
        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            background: #1e1e1e;
            border-top: 1px solid #333;
        }

        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-item.active {
            background: #333;
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* Name Modal */
        #nameModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            display: none; /* Initially hidden */
            z-index: 1000;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        #nameModal .modal-content h2 { /* Added for better structure if needed */
            margin-bottom: 15px;
        }

        #nameInput, #emailInput { /* Applied styles to both */
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #555;
            border-radius: 90px; /* This seems like a large radius, kept as is */
            margin-bottom: 15px;
            background-color: #2c2c2c;
            color: white;
            outline: none; /* Added for consistency */
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px; /* Added gap for better spacing */
        }

        #skipButton, #saveButton {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #saveButton {
            background-color: #00b894;
            color: white;
        }

        #skipButton {
            background-color: #d63031;
            color: white;
        }

        /* Animations */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .text-container {
                font-size: 2rem;
            }

            .history-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Disable text selection highlighting */
body {
    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
    -khtml-user-select: none; /* Konqueror HTML */
    -moz-user-select: none; /* Firefox */
    user-select: none; /* Standard syntax */
}

/* Optional: Allow selection in input fields */
input, textarea {
    -webkit-user-select: text !important;
    user-select: text !important;
}

/* ===== COPY BUTTON STYLES ===== */
.message.bot {
    position: relative;
    padding-right: 40px; /* Make space for button */
}

.copy-btn {
    position: absolute;
    right: 10px;
    top: 10px;
    background: #333;
    color: white;
    border: none;
    border-radius: 4px;
    width: 25px;
    height: 25px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.message.bot:hover .copy-btn {
    opacity: 1;
}

.copy-btn i {
    font-size: 12px;
}

/* Mobile always show */
@media (max-width: 768px) {
    .copy-btn {
        opacity: 1 !important;
    }
}

/* ===== SIMPLE MODAL STYLES ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.simple-modal {
    background: #252525;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border: 1px solid #444;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.modal-btn {
    flex: 1;
    padding: 10px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

.modal-btn.confirm {
    background: #d63031;
    color: white;
}

.modal-btn.cancel {
    background: #333;
    color: white;
}

.modal-btn:hover {
    transform: translateY(-2px);
}


/* Clear History Button Styles */
.action-btn {
    background: linear-gradient(45deg, #d63031, #ff7675);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(214, 48, 49, 0.3);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(214, 48, 49, 0.4);
}

.action-btn:active {
    transform: translateY(0);
}

/* Adjust the actions container */
.actions {
    margin: 20px 0;
    display: flex;
    justify-content: flex-end;
}

@media (max-width: 768px) {
    .action-btn {
        width: 100%;
        justify-content: center;
        padding: 12px;
    }

    .actions {
        padding: 0 10px;
    }
}

/* Remove tap highlights on all elements */
* {
    -webkit-tap-highlight-color: transparent;
}

/* Specifically for your Clear History button */
.action-btn {
    -webkit-tap-highlight-color: transparent;
    tap-highlight-color: transparent;
}

/* Remove mobile highlight effects */
.action-btn {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    outline: none;
}

/* History Card Styles */
.history-card {
    background: #1e1e1e;
    border-radius: 12px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    border: 1px solid #333;
}

.card-header {
    padding: 1rem;
    background: #252525;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    margin: 0;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70%;
}

.card-header .date {
    color: #aaa;
    font-size: 0.8rem;
}

.card-content {
    padding: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
}

.conversation-item {
    margin-bottom: 1rem;
    padding: 0.5rem;
    border-bottom: 1px solid #2a2a2a;
}

.conversation-item:last-child {
    border-bottom: none;
}

.time-stamp {
    color: #FFA500;
    font-size: 0.7rem;
    margin-bottom: 0.3rem;
}

/* Make messages more compact in history view */
.card-content .message {
    margin: 0.3rem 0;
    padding: 0.5rem;
    max-width: 100%;
    font-size: 0.9rem;
}

.card-content .user {
    margin-left: 0;
}

.card-content .bot {
    margin-right: 0;
}

.history-card:not(.expanded) .card-content {
    display: none;
}

.history-card.expanded .card-content {
    display: block;
}

/* History Card Dropdown Styles */
.card-header {
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}

.card-header:hover {
    background: #2e2e2e;
}

.toggle-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    transition: transform 0.2s;
    font-size: 0.9rem;
    color: #aaa;
}

.history-card.expanded .toggle-icon {
    transform: translateY(-50%) rotate(180deg);
}

.continue-chat-btn {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    background: linear-gradient(45deg, #4CAF50, #45A049);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.continue-chat-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
}

.continue-chat-btn:active {
    transform: translateY(0);
}

/* Animation for dropdown */
.card-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    padding: 0 1.2rem;
}

.history-card.expanded .card-content {
    max-height: 500px;
    padding: 1.2rem;
}

/* Thinking Mode Styles - UPDATED */
.thinking-mode {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background: #252525;
    border-radius: 15px;
    margin: 10px 15px;
    max-width: 80%;
    align-self: flex-start;
    animation: fadeIn 0.3s ease-out;
}

.thinking-text {
    font-size: 14px;
    color: #aaa;
    margin-right: 8px;
}

.thinking-dots {
    display: flex;
    gap: 5px;
}

.thinking-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #FFA500;
    opacity: 0.4;
    animation: thinking-pulse 1.5s infinite ease-in-out;
}

.thinking-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.thinking-dot:nth-child(3) {
    animation-delay: 0.4s;
}

/* Add this with your other keyframes */
@keyframes thinking-pulse {
    0%, 100% {
        opacity: 0.4;
        transform: scale(0.9);
    }
    50% {
        opacity: 1;
        transform: scale(1.1);
    }
}

/* Add to your existing styles */
.chat-welcome-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #FFA500;
    font-size: 1.5rem;
    opacity: 0.7;
    pointer-events: none;
}

#network-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
    z-index: 1000;
}

#network-status.online {
    background-color: #00c853;
    color: white;
}

#network-status.offline {
    background-color: #d50000;
    color: white;
}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div id="welcome-page">
        <div class="text-container">
            <div id="animatedText" class="fade-text"></div>

        </div>
    </div>


    <!-- Add this button anywhere in your app-container -->
<button id="reset-user" style="position: fixed; bottom: 70px; right: 10px; z-index: 1000; padding: 8px 12px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
    Reset User
</button>


    <div id="app-container">
        <div id="chat-container">
            <div id="chat-box"></div>
            <div id="input-container">
                <input type="text" id="user-input" placeholder="Message...">
                <button id="send-button">Send</button>
            </div>
            <div id="network-status" class="offline">Offline</div>
        </div>

        <div id="history-page">

            <div class="actions">
                <button id="clear-history" class="action-btn">
    <i class="fas fa-trash-alt"></i> Clear History
</button>
            </div>
            <div id="history-container"></div>
            <div id="empty-state" class="empty-state" style="display: none;">

                <h2>No Chat History</h2>
                <p>Your conversation history will appear here</p>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="nav-chat">
                <i class="fas fa-comment-alt"></i>
                <div>Chat</div>
            </div>
            <div class="nav-item" id="nav-history">
                <i class="fas fa-history"></i>
                <div>History</div>
            </div>
        </div>
    </div>

    <div id="nameModal">
        <div class="modal-content">
            <h2>Hi, I'm Spencer.<br>What's your name & email?</h2>
            <input type="text" id="nameInput" placeholder="Enter your name here">
            <input type="email" id="emailInput" placeholder="Enter your email here">
            <div class="button-group">

                <button id="saveButton">Save</button>
            </div>
        </div>
    </div>

    <script>

    // Add this to your existing JavaScript
document.getElementById('reset-user').addEventListener('click', function() {
    // Clear user data from localStorage
    localStorage.removeItem(CONFIG.userNameKey);
    localStorage.removeItem(CONFIG.userEmailKey);

    // Show welcome page again
    appContainer.style.display = 'none';
    welcomePage.style.display = 'flex';

    // Reset the animated text
    displayWelcomeMessage();

    alert("User data cleared. Welcome page will show again.");
});

        // Configuration
        const CONFIG = {
            chatHistoryKey: "spencer_chat_history",
            userNameKey: "spencer_user_name",
            userEmailKey: "spencer_user_email", // <-- ADDED EMAIL KEY

            geminiApiKey: "AIzaSyCYbhOMG6KKiNW6xNyyO2tCt2hWF3fBCDo" // Gemini API Key

        };

        // DOM Elements

        // Add this with your other DOM elements
const THINKING_MESSAGES = [
    "Processing your request...",
    "Thinking carefully...",
    "Generating response...",
    "Working on it...",
     "Give me a sec...",
      "hmmm..."
];
        const welcomePage = document.getElementById('welcome-page');
        const appContainer = document.getElementById('app-container');
        const chatContainer = document.getElementById('chat-container');
        const historyPage = document.getElementById('history-page');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const navChat = document.getElementById('nav-chat');
        const navHistory = document.getElementById('nav-history');
        const historyContainer = document.getElementById('history-container');
        const emptyState = document.getElementById('empty-state');
        const clearHistoryBtn = document.getElementById('clear-history');
        const nameModal = document.getElementById('nameModal');

        // Online/Offline state
let isOnline = window.navigator.onLine;

// Elements
const networkStatus = document.getElementById("network-status");

// Set up listeners
window.addEventListener("online", () => {
    isOnline = true;
    updateNetworkIndicator();
});
window.addEventListener("offline", () => {
    isOnline = false;
    updateNetworkIndicator();
});

function updateNetworkIndicator() {
    if (isOnline) {
        networkStatus.classList.add("online");
        networkStatus.classList.remove("offline");
        networkStatus.textContent = "Online";
    } else {
        networkStatus.classList.add("offline");
        networkStatus.classList.remove("online");
        networkStatus.textContent = "Offline";
    }
}

function saveToLocalStorage(userMsg, botMsg) {
    let history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || {};
    history[userMsg] = botMsg;
    localStorage.setItem(CONFIG.chatHistoryKey, JSON.stringify(history));
}

function getFromLocalStorage(userMsg) {
    let history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || {};
    return history[userMsg];
}

        const nameInput = document.getElementById('nameInput');
        const emailInput = document.getElementById('emailInput'); // <-- ADDED EMAIL INPUT ELEMENT
        const saveButton = document.getElementById('saveButton');
        const animatedText = document.getElementById('animatedText');


        // State
        let currentPage = 'chat';

        // Initialize the app
        function initApp() {
            const savedUsername = localStorage.getItem(CONFIG.userNameKey);

            // const savedEmail = localStorage.getItem(CONFIG.userEmailKey); // We might use this later if needed

            if (!savedUsername) {
    showNameModal();
}
             else {
                displayWelcomeMessage(savedUsername);
            }
            setupEventListeners();
        }

        function setupEventListeners() {
            welcomePage.addEventListener('click', startChatApp);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            sendButton.addEventListener('click', sendMessage);
            navChat.addEventListener('click', () => switchPage('chat'));
            navHistory.addEventListener('click', () => switchPage('history'));
            clearHistoryBtn.addEventListener('click', function(e) {
    e.preventDefault(); // Prevent default behavior
    clearHistory(); // Just shows the modal
});

            saveButton.addEventListener('click', saveNameAndEmail); // Renamed for clarity

        clearHistoryBtn.addEventListener('click', clearHistory);

         // Add modal close when clicking outside
    document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('confirmModal')) {
            document.getElementById('confirmModal').classList.remove('active');
        }
    });


// Add these new event listeners at the end of your setupEventListeners function:
document.getElementById('confirmClear').addEventListener('click', () => {
    localStorage.removeItem(CONFIG.chatHistoryKey);
    loadHistoryView();
    if (currentPage === 'chat') {
        chatBox.innerHTML = '';
    }
    document.getElementById('confirmModal').classList.remove('active');
});

document.getElementById('cancelClear').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.remove('active');
});

document.getElementById('confirmClear').addEventListener('click', () => {
    // ACTUAL clearing happens here only after confirmation
    localStorage.removeItem(CONFIG.chatHistoryKey);
    loadHistoryView();
    chatBox.innerHTML = ''; // Clear chat view too
    document.getElementById('confirmModal').classList.remove('active');
});

        }






        function showNameModal() {
            nameModal.style.display = 'block';
        }

        function hideNameModal() {
            nameModal.style.display = 'none';
        }


        // Basic email validation (you might want a more robust one)
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

       async function saveNameAndEmail() {
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();

    if (!name) {
        alert('Please enter a valid name!');
        return;
    }
    if (!email) {
        alert('Please enter your email!');
        return;
    }
    if (!isValidEmail(email)) {
        alert('Please enter a valid email address!');
        return;
    }

    // Show loading state
    saveButton.disabled = true;
    saveButton.textContent = 'Sending...';

    try {
        const submissionSuccess = await submitUserInfo(name, email);

        if (submissionSuccess) {
            localStorage.setItem(CONFIG.userNameKey, name);
            localStorage.setItem(CONFIG.userEmailKey, email);
            hideNameModal();
            displayWelcomeMessage(name);
        } else {
            alert('Failed to submit your information. Please try again.');
        }
    } catch (error) {
        console.error('Error in saveNameAndEmail:', error);
        alert('An unexpected error occurred. Please try again.');
    } finally {
        // Reset button state
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
    }
}

        // NEW FUNCTION TO "SUBMIT" USER INFO

        async function submitUserInfo(name, email) {
    const formSubmitURL = 'https://formsubmit.co/ukowills@gmail.com';

    const data = {
        name: name,
        email: email,
        _subject: "New User Sign-up from Spencer Chat",
        _template: "table",
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch(formSubmitURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data),
        });

        // Get the response text (formsubmit.co returns HTML)
        const responseText = await response.text();
        console.log('Form submission response:', responseText);

        if (response.ok) {
            console.log('Successfully submitted to formsubmit.co');
            return true; // Indicate success
        } else {
            console.error('Submission failed with status:', response.status);
            return false; // Indicate failure
        }
    } catch (error) {
        console.error('Error submitting to formsubmit.co:', error);
        return false; // Indicate failure
    }
}


        function displayWelcomeMessage(name = null) {
            const timeGreeting = getTimeGreeting();
            let greetingText;

            if (name) {
                greetingText = `${timeGreeting}, ${name}. Tap to chat`;
            } else {
                greetingText = `${timeGreeting}. I'm Spencer. Tap to chat`;
            }
            animateText(greetingText);
        }

        function animateText(text) {
            animatedText.textContent = "";
            let index = 0;
            function typeWriter() {
                if (index < text.length) {
                    animatedText.textContent += text.charAt(index);
                    index++;
                    setTimeout(typeWriter, 50);
                }
            }
            typeWriter();
        }

        function getTimeGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good morning";
            if (hour < 18) return "Good afternoon";
            return "Good evening";
        }

        function startChatApp() {
            welcomePage.style.display = 'none';
            appContainer.style.display = 'flex';
            loadChatHistory();
        }

        function switchPage(page) {
            currentPage = page;
            if (page === 'chat') {
                chatContainer.style.display = 'flex';
                historyPage.style.display = 'none';
                navChat.classList.add('active');
                navHistory.classList.remove('active');
            } else {
                chatContainer.style.display = 'none';
                historyPage.style.display = 'block';
                navChat.classList.remove('active');
                navHistory.classList.add('active');
                loadHistoryView();
            }
        }

      async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    userInput.value = '';

    // Check cache first (works offline)
    const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || {};
    if (history[message]) {
        addMessage(history[message], 'bot');
        return;
    }

    // Online: Call API
    if (isOnline) {
        const thinkingElement = createThinkingElement();
        chatBox.appendChild(thinkingElement);

        try {
            const response = await generateResponse(message);
            chatBox.removeChild(thinkingElement);
            addMessage(response, 'bot');
            saveChatHistory(message, response); // Save to cache
        } catch (error) {
            chatBox.removeChild(thinkingElement);
            const fallback = getOfflineResponse(message);
            addMessage(fallback, 'bot');
        }
    }
    // Offline: Show fallback
    else {
        const fallback = getOfflineResponse(message);
        addMessage(fallback, 'bot');
    }
}


// Helper function to create thinking element
function createThinkingElement() {
    const container = document.createElement('div');
    container.className = 'thinking-mode';

    const text = document.createElement('span');
    text.className = 'thinking-text';
    text.textContent = THINKING_MESSAGES[Math.floor(Math.random() * THINKING_MESSAGES.length)];

    const dots = document.createElement('div');
    dots.className = 'thinking-dots';

    // Add three animated dots
    for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'thinking-dot';
        dots.appendChild(dot);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    container.appendChild(text);
    container.appendChild(dots);

    return container;
}

        function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;

    if (sender === 'bot') {
        messageDiv.innerHTML = `
            ${text}
            <button class="copy-btn" title="Copy to clipboard">
                <i class="fas fa-copy"></i>
            </button>
        `;

        // Add copy functionality
        const copyBtn = messageDiv.querySelector('.copy-btn');
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                copyBtn.style.background = '#4CAF50';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.style.background = '#333';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                copyBtn.style.background = '#f44336';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.style.background = '#333';
                }, 2000);
            });
        });
    } else {
        messageDiv.textContent = text;
    }

    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

       async function generateResponse(input) {
        console.log("User Input:", input);

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.geminiApiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: input
                        }]
                    }]
                })
            });

            const data = await response.json();
            console.log("API Response:", data);

            if (data.candidates && data.candidates[0].content.parts[0].text) {
                return formatBotResponse(data.candidates[0].content.parts[0].text);
            } else {
                console.error("Unexpected API response format");
                return getOfflineResponse(input);
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            return getOfflineResponse(input);
        }
    }

    function formatBotResponse(text) {
        // 1. Remove markdown syntax
        text = text.replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold (**text**)
                   .replace(/\*(.*?)\*/g, '$1')     // Remove italic (*text*)
                   .replace(/`(.*?)`/g, '$1')       // Remove code (`text`)
                   .replace(/\[(.*?)\]\(.*?\)/g, '$1'); // Remove links ([text](url))

        // 2. Convert line breaks to paragraphs when there are double line breaks
        text = text.replace(/\n\n+/g, '</p><p>');

        // 3. Wrap the entire content in paragraphs (if not already)
        if (!text.startsWith('<p>')) {
            text = '<p>' + text + '</p>';
        }

        // 4. Preserve single line breaks as <br> tags
        text = text.replace(/\n/g, '<br>');

        // 5. Clean up any resulting HTML oddities
        text = text.replace(/<p><\/p>/g, '') // Remove empty paragraphs
                   .replace(/<p><br><\/p>/g, '') // Remove paragraphs with just line breaks
                   .replace(/\s+/g, ' ') // Collapse multiple spaces
                   .trim();

        return text;
    }

        function getOfflineResponse(input) {
            // Your existing offline responses
            const offlineResponses = [
                "Hi there! I'm Spencer, your AI assistant. Currently offline, but I'd love to help more when we connect online.",
                "Hello! For my best assistance, I'll need to sync with you online first.",
                "Greetings! I'm just getting to know you - chatting online will help me learn how to assist you better.",
                "I'm currently offline, so my responses are limited. Connecting online will give me full functionality."
            ];

            return offlineResponses[Math.floor(Math.random() * offlineResponses.length)];
        }


        function saveChatHistory(userMsg, botMsg) {
    // Get existing history or initialize as array
    const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];

    // Add new conversation with timestamp
    history.push({
        user: userMsg,
        bot: botMsg,
        timestamp: new Date().toISOString()
    });

    // Save back to localStorage
    localStorage.setItem(CONFIG.chatHistoryKey, JSON.stringify(history));
}
        function loadChatHistory() {
    const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];
    chatBox.innerHTML = '';

    // Load all cached messages
    history.forEach(entry => {
        addMessage(entry.user, 'user');
        addMessage(entry.bot, 'bot');
    });

    // Show welcome if empty
    if (history.length === 0) {
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'chat-welcome-message';
        welcomeMsg.textContent = '';
        chatBox.appendChild(welcomeMsg);
    }
}

        function loadHistoryView() {
    const history = JSON.parse(localStorage.getItem(CONFIG.chatHistoryKey)) || [];
    historyContainer.innerHTML = '';

    if (history.length === 0) {
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';

    // Group conversations by calendar date
    const groupedByDate = history.reduce((groups, entry) => {
        const dateObj = new Date(entry.timestamp);
        const dateKey = `${dateObj.getFullYear()}-${dateObj.getMonth()+1}-${dateObj.getDate()}`;

        if (!groups[dateKey]) {
            groups[dateKey] = [];
        }
        groups[dateKey].push(entry);
        return groups;
    }, {});

    // Sort dates in descending order
    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

    sortedDates.forEach(dateKey => {
        const conversations = groupedByDate[dateKey];
        const dateObj = new Date(dateKey);
        const card = document.createElement('div');
        card.className = 'history-card';

        // Format date nicely
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Use first message as title
        const firstConvo = conversations[0];
        const title = firstConvo.user.length > 30
            ? firstConvo.user.substring(0, 30) + '...'
            : firstConvo.user;

        card.innerHTML = `
            <div class="card-header">
                <h3>${title}</h3>
                <div class="date">${formattedDate}</div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div class="card-content">
                ${conversations.map(convo => `
                    <div class="conversation-item">
                        <div class="time-stamp">
                            ${new Date(convo.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                        </div>
                        <div class="message user">${convo.user}</div>
                        <div class="message bot">
                            ${convo.bot}
                            <button class="copy-btn" title="Copy to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
                <button class="continue-chat-btn">
                    <i class="fas fa-comment"></i> Continue this chat
                </button>
            </div>
        `;

        // Add event listeners
        const continueBtn = card.querySelector('.continue-chat-btn');
        continueBtn.addEventListener('click', () => {
            switchPage('chat');
            chatBox.innerHTML = '';
            conversations.forEach(convo => {
                addMessage(convo.user, 'user');
                addMessage(convo.bot, 'bot');
            });
        });

        // Toggle functionality
        const header = card.querySelector('.card-header');
        header.addEventListener('click', () => {
            card.classList.toggle('expanded');
        });

        historyContainer.appendChild(card);
    });
}
        function clearHistory() {
             // Show our custom modal instead of default confirm
    document.getElementById('confirmModal').classList.add('active');{

    // Just show the modal - no clearing happens here
    document.getElementById('confirmModal').classList.add('active');
    return false; // Prevent default behavior
}
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Simple Modal -->
<div class="modal-overlay" id="confirmModal">
    <div class="simple-modal">
        <h3>Clear All History?</h3>
        <p>This will permanently delete all your chat history.</p>
        <div class="modal-actions">
            <button class="modal-btn cancel" id="cancelClear">Cancel</button>
            <button class="modal-btn confirm" id="confirmClear">Clear</button>
        </div>
    </div>
</div>
</body>
</html>
